name: Seed Product Mappings

on:
  workflow_dispatch:
    inputs:
      data_dir:
        description: 'Local data directory (leave default unless you know what you are doing)'
        required: false
        default: './data/raw'
        type: string

jobs:
  seed:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install \
            sqlalchemy psycopg2-binary python-dotenv \
            pandas openpyxl xlrd \
            google-api-python-client google-auth google-auth-httplib2

      - name: Restore Google token
        run: echo "${{ secrets.GOOGLE_TOKEN_JSON }}" | base64 -d > token.json

      - name: Download latest portal data from Drive
        env:
          GOOGLE_DRIVE_ROOT_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_ROOT_FOLDER_ID }}
          RAW_DATA_PATH: ./data/raw
        run: |
          python - <<'EOF'
          import os, sys
          sys.path.insert(0, '.')
          from pathlib import Path
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaIoBaseDownload
          from google.oauth2.credentials import Credentials
          import io

          creds = Credentials.from_authorized_user_file("token.json")
          drive = build("drive", "v3", credentials=creds)

          root_id = os.environ.get("GOOGLE_DRIVE_ROOT_FOLDER_ID", "")
          raw_path = Path(os.environ.get("RAW_DATA_PATH", "./data/raw"))

          PORTALS = ["easyecom", "blinkit", "zepto", "swiggy", "amazon_pi"]

          def find_folder(parent_id, name):
              q = f"'{parent_id}' in parents and name='{name}' and mimeType='application/vnd.google-apps.folder' and trashed=false"
              res = drive.files().list(q=q, fields="files(id,name)").execute()
              return res.get("files", [{}])[0].get("id")

          def latest_file(folder_id):
              q = f"'{folder_id}' in parents and trashed=false"
              res = drive.files().list(q=q, fields="files(id,name,modifiedTime)", orderBy="modifiedTime desc", pageSize=1).execute()
              files = res.get("files", [])
              return files[0] if files else None

          def download(file_id, dest):
              dest.parent.mkdir(parents=True, exist_ok=True)
              request = drive.files().get_media(fileId=file_id)
              with open(dest, "wb") as fh:
                  dl = MediaIoBaseDownload(fh, request)
                  done = False
                  while not done:
                      _, done = dl.next_chunk()

          if not root_id:
              print("GOOGLE_DRIVE_ROOT_FOLDER_ID not set — skipping Drive download.")
              sys.exit(0)

          for portal in PORTALS:
              folder_id = find_folder(root_id, portal)
              if not folder_id:
                  print(f"No Drive folder for {portal} — skipping.")
                  continue
              f = latest_file(folder_id)
              if not f:
                  print(f"No files in Drive folder for {portal} — skipping.")
                  continue
              dest = raw_path / portal / f["name"]
              if dest.exists():
                  print(f"Already have {f['name']} — skipping download.")
                  continue
              download(f["id"], dest)
              print(f"Downloaded {f['name']} → {dest}")
          EOF

      - name: Seed products and portal mappings from portal files
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          python scripts/seed_from_portal_files.py \
            --data-dir "${{ github.event.inputs.data_dir }}" \
            --report data/source/mapping_gaps.csv

      - name: Upload mapping gaps report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mapping-gaps-${{ github.run_id }}
          path: data/source/mapping_gaps.csv
          if-no-files-found: ignore
