name: Scraper — Zepto

on:
  push:
    branches: ["**"]  # suppresses phantom push-failure records; job is skipped on push
  schedule:
    - cron: "40 5 * * *"  # 11:10 AM IST daily
  workflow_dispatch:
    inputs:
      report_date:
        description: "Date to scrape (YYYY-MM-DD). Defaults to yesterday."
        required: false
        default: ""

jobs:
  run-scraper:
    name: Run Zepto scraper
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          pip install -r scrapers/requirements.txt
          pip install pyotp google-auth google-auth-oauthlib google-api-python-client python-dotenv

      - name: Install Playwright browsers
        run: playwright install chromium --with-deps

      - name: Restore Google token
        run: echo "${{ secrets.GOOGLE_TOKEN_JSON }}" | base64 -d > token.json

      - name: Create data directories
        run: mkdir -p data/raw/zepto

      - name: Run Zepto scraper
        env:
          ZEPTO_LINK: ${{ secrets.ZEPTO_LINK }}
          ZEPTO_EMAIL: ${{ secrets.ZEPTO_EMAIL }}
          ZEPTO_PASSWORD: ${{ secrets.ZEPTO_PASSWORD }}
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          PROFILE_STORAGE_DRIVE_FOLDER_ID: ${{ secrets.PROFILE_STORAGE_DRIVE_FOLDER_ID }}
          RAW_DATA_PATH: ./data/raw
          INPUT_REPORT_DATE: ${{ github.event.inputs.report_date }}
        run: |
          python - <<'EOF'
          import sys, os
          from datetime import date, timedelta
          sys.path.insert(0, '.')

          report_date_str = os.environ.get("INPUT_REPORT_DATE", "").strip()
          if report_date_str:
              from datetime import datetime
              report_date = datetime.strptime(report_date_str, "%Y-%m-%d").date()
          else:
              report_date = date.today() - timedelta(days=1)

          from scrapers.zepto_scraper import ZeptoScraper
          result = ZeptoScraper(headless=True).run(report_date=report_date)
          print("Result:", result)
          if result.get("status") in ("error", "failed"):
              sys.exit(1)
          EOF

      - name: Populate DB from downloaded data
        if: success()
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          INPUT_REPORT_DATE: ${{ github.event.inputs.report_date }}
        run: |
          pip install -r backend/requirements.txt -q
          python - <<'EOF'
          import sys, os, re
          from datetime import date, timedelta
          from urllib.parse import urlparse, urlunparse
          sys.path.insert(0, '.')

          # Supabase direct DB (db.<ref>.supabase.co) is IPv6-only on GitHub Actions.
          # Rewrite to the connection pooler (<ref>.pooler.supabase.com) which has IPv4.
          def _pooler_url(url):
              if not url: return url
              _p = urlparse(url)
              _m = re.match(r'^(?:db\.)?([a-zA-Z0-9-]+)\.supabase\.co$', (_p.hostname or "").strip())
              if _m:
                  _ref = _m.group(1); _pooler = f"{_ref}.pooler.supabase.com"
                  print(f"[DB] Supabase pooler: {_p.hostname} -> {_pooler}", flush=True)
                  return urlunparse(_p._replace(netloc=_p.netloc.replace(_p.hostname, _pooler, 1)))
              return url
          os.environ["DATABASE_URL"] = _pooler_url(os.environ.get("DATABASE_URL", ""))
          _h = os.environ.get("POSTGRES_HOST", "").strip()
          _hparts = _h.split(".") if _h else []
          print(f"[DB-DIAG] HOST={len(_hparts)}pts,ends={'.'.join(_hparts[-2:]) if len(_hparts)>=2 else (_h or 'empty')},DB_URL={'set' if os.environ.get('DATABASE_URL') else 'empty'}", flush=True)
          _m2 = re.match(r'^(?:db\.)?([a-zA-Z0-9-]+)\.supabase\.co$', _h) if _h else None
          if _m2:
              os.environ["POSTGRES_HOST"] = f"{_m2.group(1)}.pooler.supabase.com"
              print(f"[DB] Supabase pooler (HOST): {_h} -> {os.environ['POSTGRES_HOST']}", flush=True)
              os.environ.pop("DATABASE_URL", None)  # Force settings to use patched POSTGRES_HOST
              print("[DB] Cleared DATABASE_URL; using POSTGRES_HOST pooler endpoint", flush=True)

          report_date_str = os.environ.get("INPUT_REPORT_DATE", "").strip()
          if report_date_str:
              from datetime import datetime
              report_date = datetime.strptime(report_date_str, "%Y-%m-%d").date()
          else:
              report_date = date.today() - timedelta(days=1)

          from scrapers.orchestrator import populate_portal_data
          result = populate_portal_data(portal_name="zepto", report_date=report_date)
          print("DB populate result:", result)
          EOF

      - name: Upload data artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zepto-data-${{ github.run_id }}
          path: data/raw/zepto/
          retention-days: 7

      - name: Upload debug screenshots on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: zepto-debug-${{ github.run_id }}
          path: data/raw/zepto/debug_*.png
          retention-days: 3

      - name: Slack alert on failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -s -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "text": ":warning: *Zepto scraper failed* — session or OTP issue.\n\n*Action needed:*\n1. Run locally in visible mode: `python scrapers/zepto_scraper.py`\n2. Complete the OTP login in the browser window\n3. Re-run the workflow: https://github.com/${{ github.repository }}/actions/workflows/scraper-zepto.yml\n\n_Run:_ <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_id }}>"
            }'
