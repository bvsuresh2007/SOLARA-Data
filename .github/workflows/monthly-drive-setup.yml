name: Monthly Drive Folder Setup

on:
  schedule:
    # 1st of every month at 00:30 IST (19:00 UTC previous day â†’ use 18:30 UTC on 1st)
    # IST = UTC+5:30, so midnight IST = 18:30 UTC
    - cron: '30 18 1 * *'
  workflow_dispatch:
    inputs:
      month:
        description: 'Target month as YYYY-MM (leave blank for current month)'
        required: false
        default: ''

jobs:
  setup-drive-folder:
    name: Create monthly Drive folders + notify Slack
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements.txt

      - name: Install dependencies
        run: |
          pip install \
            google-auth \
            google-auth-httplib2 \
            google-api-python-client \
            python-dotenv \
            requests \
            pydantic-settings

      - name: Create month folder + portal subfolders + notify Slack
        env:
          GMAIL_TOKEN_JSON: ${{ secrets.GMAIL_TOKEN_JSON }}
          GOOGLE_DRIVE_ROOT_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_ROOT_FOLDER_ID }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "${{ github.event.inputs.month }}" ]; then
            python scripts/setup_monthly_drive_folder.py --month "${{ github.event.inputs.month }}"
          else
            python scripts/setup_monthly_drive_folder.py
          fi
